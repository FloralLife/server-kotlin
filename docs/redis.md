# Redis 를 이용한 성능 개선

## 1. 배경

대용량 트래픽이 몰리거나 성능적으로 크게 개선될 수 있는 부분은 이커머스 서비스 내에서는 다음과 같다고 판단했습니다.

- 쿠폰 발급의 경우, 주어진 재고 내에서만 발급되어야 하므로 높은 동시성을 처리해야 합니다.
- Top 5 상품 조회의 경우, 매번 대규모 주문(Order) 데이터를 집계해야 하므로 성능 부담이 커집니다.

이에 Redis를 도입하여, 다음과 같이 성능을 개선하려고 합니다.

- 선착순 쿠폰 발급 시 DB 락으로 인한 대기시간 감소 + 원자적인 재고 감소
- Top 5 상품 조회 시 캐싱을 통해 빠른 응답을 제공

---

## 2. 문제

### 2.1 선착순 쿠폰 발급 문제

- DB 락으로 인한 병목
  - 기존에는 RDB 테이블에서 선착순을 보장하기 위해 베타 락을 사용했습니다.
  - 트래픽이 몰릴 때 락 경합이 심해져, 성능 저하와 대기 시간 증가가 발생합니다.

### 2.2 Top 5 상품 조회 문제

- 쿼리 지연 시간이 큼
  - 매번 집계 쿼리를 통해 상위 5개 상품을 조회합니다.
  - 데이터가 많을수록 쿼리 실행 시간이 길어집니다.

- 빈번한 조회 요청
  - 메인 페이지나 앱 홈 화면에서 Top N 상품을 노출하는 경우 DB가 다수의 조회 트래픽에 의해 부하가 급증합니다.

---

## 3. AS-IS

### 1. 쿠폰 발급

- `coupon` 테이블에서 `stock` 컬럼을 사용해 재고를 관리합니다.
- 발급 시 `SELECT * FROM coupon WHERE id = ? FOR UPDATE` 로 coupon 행에 락을 걸어 동시에 하나의 트랜잭션만 업데이트 가능하게 제어합니다.
- 한 쿠폰이 같은 사람에게 중복 발급되는 것을 DB의 unique 인덱스로 방지하고 있기 때문에 DB에 저장될 때 실패하는 것을 알 수 있습니다.
- 동시에 많은 요청이 몰리면 락으로 인해 DB 부하가 증가하며, 응답 지연도 발생합니다.

### 2. Top 5 상품 조회

- `order`, `order_product` 테이블에서 상품별 판매량을 합산 후 집계 쿼리로 상위 5개를 구합니다.
- 요청이 많으면 DB 의 성능이 느려질 수 있습니다.

---

## 4. TO-BE

### 4.1 쿠폰 발급 기능 – Redis 활용

- Lua 스크립트에 중복 검사, 쿠폰 재고 감소, 발급 명단에 추가하는 로직을 작성하여 세가지 명령을 원자적으로 처리합니다.
- Redis와의 통신을 최소화할 수 있으며 Redis의 트랜잭션, 낙관적 락 없이도 동시성 문제를 해결할 수 있습니다.

#### Lua script 로직

_Lua script 실행 이전에 Redis에 쿠폰에 대한 정보를 추가해야 합니다._

1. 쿠폰을 발급 받은 사용자 SET 에 발급 요청한 사용자가 있는지 조회 -> 있으면 바로 종료
2. 쿠폰의 남은 수량을 조회하여 0보다 많은경우 1 감소
3. 쿠폰을 발급 받은 사용자 SET에 사용자 추가

### 4.2 Top 5 상품 조회 – Redis 캐시 활용

- TOP 5 상품 목록 조회 요청이 들어올 시 Redis를 먼저 조회합니다.
- Redis에 데이터가 없으면 DB에서 조회하여 응답하며 Redis에도 저장합니다. 이때 TTL을 한시간으로 하여 캐시는 한시간마다 갱신될 수 있도록 합니다.

---

## 5. 한계점

- Redis는 기본적으로 In-Memory DB이므로 단일 노드 장애 시 데이터 손실 가능성이 있습니다.
- 캐시를 항상 유지할 수 없습니다.
  - 따로 스케줄러를 사용하여 1사간마다 캐시를 갱신하면 좋지만 이 프로젝트에선 스케줄러가 없기 때문에 이 방법은 불가능합니다.
  - 캐시가 만료된 시점에 동시에 많은 요청이 몰리면 DB에 부하가 걸릴 수 있습니다.

---

## 6. 결론 (Conclusion)

- 선착순 쿠폰 발급
  - 기존 DB 락 중심 방식 대신, Redis 원자적 연산을 활용하여 동시성을 처리하고 DB의 부하를 줄입니다.

- Top 5 상품 조회
  - 매번 집계 쿼리를 수행하지 않고 Redis 캐싱 방식을 도입함으로써, 사용자 조회 시에는 즉시 응답이 가능해지고, DB 부하가 크게 감소합니다.
